<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LG TV Controller</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        :root { --bs-body-bg: #1a1a2e; --bs-body-color: #e0e0e0; }
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; color: #e0e0e0; }
        .card { background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        .card-header { background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .btn-tv { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; transition: all 0.2s; }
        .btn-tv:hover { background: rgba(255,255,255,0.2); color: #fff; transform: scale(1.05); }
        .btn-tv:active { transform: scale(0.95); }
        .btn-tv.btn-danger-tv { background: rgba(220,53,69,0.3); border-color: rgba(220,53,69,0.5); }
        .btn-tv.btn-danger-tv:hover { background: rgba(220,53,69,0.5); }
        .btn-tv.btn-success-tv { background: rgba(25,135,84,0.3); border-color: rgba(25,135,84,0.5); }
        .btn-tv.btn-success-tv:hover { background: rgba(25,135,84,0.5); }
        .btn-tv.btn-primary-tv { background: rgba(13,110,253,0.3); border-color: rgba(13,110,253,0.5); }
        .btn-tv.btn-primary-tv:hover { background: rgba(13,110,253,0.5); }
        .btn-tv.btn-warning-tv { background: rgba(255,193,7,0.3); border-color: rgba(255,193,7,0.5); color: #ffc107; }
        .btn-tv.btn-warning-tv:hover { background: rgba(255,193,7,0.5); }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .status-dot.connected { background: #00ff88; box-shadow: 0 0 8px #00ff88; }
        .status-dot.disconnected { background: #ff4444; box-shadow: 0 0 8px #ff4444; }
        .volume-slider { width: 100%; accent-color: #00ff88; }
        .app-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; max-height: 300px; overflow-y: auto; }
        .app-btn { font-size: 0.75rem; padding: 8px 4px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .quick-apps { display: flex; flex-wrap: wrap; gap: 6px; }
        .log-area { font-family: monospace; font-size: 0.8rem; max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; }
        .log-entry { margin-bottom: 2px; opacity: 0.8; }
        .log-entry.error { color: #ff6b6b; }
        .log-entry.success { color: #51cf66; }
        h5 { font-weight: 600; }
        .navbar-brand { font-weight: 700; letter-spacing: 1px; }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark py-2" style="background: rgba(0,0,0,0.3);">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="bi bi-tv"></i> LG TV Controller
            </span>
            <div class="d-flex align-items-center gap-3">
                <span id="nowPlaying" class="text-muted small d-none">
                    <i class="bi bi-broadcast-pin"></i> <span id="nowPlayingText"></span>
                </span>
                <span id="statusText" class="text-muted small">Desconectado</span>
                <span id="statusDot" class="status-dot disconnected"></span>
                <button id="btnConnect" class="btn btn-sm btn-tv btn-success-tv" onclick="toggleConnection()">
                    <i class="bi bi-plug"></i> Conectar
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-3">
        <div class="row g-3">
            <!-- Coluna 1: Controles principais -->
            <div class="col-lg-4">
                <!-- Power -->
                <div class="card mb-3">
                    <div class="card-header"><h5 class="mb-0"><i class="bi bi-power"></i> Energia</h5></div>
                    <div class="card-body d-flex gap-2 flex-wrap">
                        <button class="btn btn-tv btn-success-tv" onclick="powerOn()">
                            <i class="bi bi-power"></i> Ligar (WOL)
                        </button>
                        <button class="btn btn-tv btn-danger-tv" onclick="apiPost('/api/power', {action:'off'})">
                            <i class="bi bi-power"></i> Desligar
                        </button>
                        <button class="btn btn-tv btn-warning-tv" onclick="apiPost('/api/power', {action:'screen_off'})">
                            <i class="bi bi-display"></i> Tela Off
                        </button>
                        <button class="btn btn-tv btn-success-tv" onclick="apiPost('/api/power', {action:'screen_on'})">
                            <i class="bi bi-display-fill"></i> Tela On
                        </button>
                    </div>
                </div>

                <!-- Volume -->
                <div class="card mb-3">
                    <div class="card-header"><h5 class="mb-0"><i class="bi bi-volume-up"></i> Volume</h5></div>
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-3 mb-3">
                            <button class="btn btn-tv" onclick="apiPost('/api/volume', {action:'down'})">
                                <i class="bi bi-volume-down-fill fs-4"></i>
                            </button>
                            <input type="range" class="volume-slider flex-grow-1" id="volumeSlider" min="0" max="100" value="0"
                                   oninput="document.getElementById('volumeValue').textContent = this.value"
                                   onchange="apiPost('/api/volume', {action:'set', level: parseInt(this.value)})">
                            <button class="btn btn-tv" onclick="apiPost('/api/volume', {action:'up'})">
                                <i class="bi bi-volume-up-fill fs-4"></i>
                            </button>
                            <span id="volumeValue" class="badge bg-secondary fs-6" style="min-width:40px">0</span>
                        </div>
                        <button id="btnMute" class="btn btn-tv w-100" onclick="toggleMute()">
                            <i class="bi bi-volume-mute-fill"></i> Mudo
                        </button>
                    </div>
                </div>

                <!-- Controles de M√≠dia -->
                <div class="card mb-3">
                    <div class="card-header"><h5 class="mb-0"><i class="bi bi-play-circle"></i> M√≠dia</h5></div>
                    <div class="card-body d-flex gap-2 justify-content-center flex-wrap">
                        <button class="btn btn-tv" onclick="apiPost('/api/media', {action:'rewind'})">
                            <i class="bi bi-skip-backward-fill fs-4"></i>
                        </button>
                        <button class="btn btn-tv btn-success-tv" onclick="apiPost('/api/media', {action:'play'})">
                            <i class="bi bi-play-fill fs-4"></i>
                        </button>
                        <button class="btn btn-tv btn-warning-tv" onclick="apiPost('/api/media', {action:'pause'})">
                            <i class="bi bi-pause-fill fs-4"></i>
                        </button>
                        <button class="btn btn-tv btn-danger-tv" onclick="apiPost('/api/media', {action:'stop'})">
                            <i class="bi bi-stop-fill fs-4"></i>
                        </button>
                        <button class="btn btn-tv" onclick="apiPost('/api/media', {action:'fast_forward'})">
                            <i class="bi bi-skip-forward-fill fs-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Canais -->
                <div class="card mb-3">
                    <div class="card-header"><h5 class="mb-0"><i class="bi bi-broadcast"></i> Canais</h5></div>
                    <div class="card-body d-flex gap-2 justify-content-center">
                        <button class="btn btn-tv" onclick="apiPost('/api/channels', {action:'down'})">
                            <i class="bi bi-chevron-down fs-4"></i>
                        </button>
                        <button class="btn btn-tv btn-primary-tv" onclick="loadChannels()">
                            <i class="bi bi-list-ul"></i> Lista
                        </button>
                        <button class="btn btn-tv" onclick="apiPost('/api/channels', {action:'up'})">
                            <i class="bi bi-chevron-up fs-4"></i>
                        </button>
                    </div>
                    <div id="channelList" class="card-body d-none">
                        <select id="channelSelect" class="form-select bg-dark text-light border-secondary" size="5"
                                onchange="apiPost('/api/channels', {action:'set', channel_id: this.value})"></select>
                    </div>
                </div>
            </div>

            <!-- Coluna 2: Apps e Inputs -->
            <div class="col-lg-4">
                <!-- Apps R√°pidos -->
                <div class="card mb-3">
                    <div class="card-header"><h5 class="mb-0"><i class="bi bi-grid"></i> Apps R√°pidos</h5></div>
                    <div class="card-body quick-apps">
                        <button class="btn btn-tv" onclick="launchApp('netflix')">
                            <i class="bi bi-film"></i> Netflix
                        </button>
                        <button class="btn btn-tv" onclick="launchApp('youtube')">
                            <i class="bi bi-youtube"></i> YouTube
                        </button>
                        <button class="btn btn-tv" onclick="launchApp('amazon_prime')">
                            <i class="bi bi-play-btn"></i> Prime
                        </button>
                        <button class="btn btn-tv" onclick="launchApp('disney_plus')">
                            <i class="bi bi-stars"></i> Disney+
                        </button>
                        <button class="btn btn-tv" onclick="launchApp('spotify')">
                            <i class="bi bi-spotify"></i> Spotify
                        </button>
                        <button class="btn btn-tv" onclick="launchApp('browser')">
                            <i class="bi bi-globe"></i> Browser
                        </button>
                        <button class="btn btn-tv" onclick="launchApp('live_tv')">
                            <i class="bi bi-broadcast"></i> TV
                        </button>
                        <button class="btn btn-tv" onclick="launchApp('settings')">
                            <i class="bi bi-gear"></i> Config
                        </button>
                    </div>
                </div>

                <!-- Inputs / Fontes -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-hdmi-port"></i> Entradas</h5>
                        <button class="btn btn-sm btn-tv" onclick="loadInputs()"><i class="bi bi-arrow-clockwise"></i></button>
                    </div>
                    <div class="card-body" id="inputsList">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-tv" onclick="apiPost('/api/apps', {action:'launch', app_id:'hdmi1'})">
                                <i class="bi bi-hdmi-port"></i> HDMI 1
                            </button>
                            <button class="btn btn-tv" onclick="apiPost('/api/apps', {action:'launch', app_id:'hdmi2'})">
                                <i class="bi bi-hdmi-port"></i> HDMI 2
                            </button>
                            <button class="btn btn-tv" onclick="apiPost('/api/apps', {action:'launch', app_id:'hdmi3'})">
                                <i class="bi bi-hdmi-port"></i> HDMI 3
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Presets / Favoritos -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-star"></i> Favoritos</h5>
                        <button class="btn btn-sm btn-tv" onclick="showPresetEditor()">
                            <i class="bi bi-plus-lg"></i> Novo
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="presetsList" class="d-flex flex-wrap gap-2">
                            <p class="text-muted small">Carregando...</p>
                        </div>
                    </div>
                    <!-- Preset Editor (hidden) -->
                    <div id="presetEditor" class="card-body border-top d-none" style="border-color: rgba(255,255,255,0.1) !important">
                        <h6 class="mb-2">Novo Favorito</h6>
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <input type="text" id="presetId" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="ID (ex: cinema)">
                            </div>
                            <div class="col-6">
                                <input type="text" id="presetName" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="Nome (ex: üé¨ Cinema)">
                            </div>
                        </div>
                        <div id="presetActions">
                            <div class="preset-action row g-1 mb-1">
                                <div class="col-4">
                                    <select class="form-select form-select-sm bg-dark text-light border-secondary preset-action-type" onchange="updateActionFields(this)">
                                        <option value="app">App</option>
                                        <option value="volume">Volume</option>
                                        <option value="input">Input HDMI</option>
                                        <option value="power">Power</option>
                                    </select>
                                </div>
                                <div class="col-7 preset-action-value">
                                    <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="App ID">
                                </div>
                                <div class="col-1">
                                    <button class="btn btn-sm btn-tv btn-danger-tv" onclick="this.closest('.preset-action').remove()">√ó</button>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2 mt-2">
                            <button class="btn btn-sm btn-tv" onclick="addPresetAction()"><i class="bi bi-plus"></i> A√ß√£o</button>
                            <button class="btn btn-sm btn-tv btn-success-tv" onclick="savePreset()"><i class="bi bi-check"></i> Salvar</button>
                            <button class="btn btn-sm btn-tv" onclick="document.getElementById('presetEditor').classList.add('d-none')">Cancelar</button>
                        </div>
                    </div>
                </div>

                <!-- Todos os Apps -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-app-indicator"></i> Todos os Apps</h5>
                        <button class="btn btn-sm btn-tv" onclick="loadApps()"><i class="bi bi-arrow-clockwise"></i></button>
                    </div>
                    <div class="card-body">
                        <div id="allApps" class="app-grid">
                            <p class="text-muted">Clique em <i class="bi bi-arrow-clockwise"></i> para carregar</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coluna 3: Remote, Info e Toast -->
            <div class="col-lg-4">
                <!-- Controle Remoto Virtual -->
                <div class="card mb-3">
                    <div class="card-header"><h5 class="mb-0"><i class="bi bi-dpad"></i> Controle Remoto</h5></div>
                    <div class="card-body">
                        <!-- Navigation D-Pad -->
                        <div class="d-flex flex-column align-items-center gap-1 mb-3">
                            <button class="btn btn-tv" onclick="sendBtn('UP')" style="width:60px">
                                <i class="bi bi-chevron-up fs-4"></i>
                            </button>
                            <div class="d-flex gap-1 align-items-center">
                                <button class="btn btn-tv" onclick="sendBtn('LEFT')" style="width:60px">
                                    <i class="bi bi-chevron-left fs-4"></i>
                                </button>
                                <button class="btn btn-tv btn-primary-tv" onclick="sendBtn('ENTER')" style="width:60px;height:60px;border-radius:50%">
                                    <span class="fw-bold">OK</span>
                                </button>
                                <button class="btn btn-tv" onclick="sendBtn('RIGHT')" style="width:60px">
                                    <i class="bi bi-chevron-right fs-4"></i>
                                </button>
                            </div>
                            <button class="btn btn-tv" onclick="sendBtn('DOWN')" style="width:60px">
                                <i class="bi bi-chevron-down fs-4"></i>
                            </button>
                        </div>
                        <!-- Action buttons -->
                        <div class="d-flex gap-2 justify-content-center flex-wrap mb-3">
                            <button class="btn btn-tv btn-danger-tv" onclick="sendBtn('BACK')">
                                <i class="bi bi-arrow-left"></i> Voltar
                            </button>
                            <button class="btn btn-tv btn-primary-tv" onclick="sendBtn('HOME')">
                                <i class="bi bi-house"></i> Home
                            </button>
                            <button class="btn btn-tv" onclick="sendBtn('EXIT')">
                                <i class="bi bi-x-circle"></i> Sair
                            </button>
                            <button class="btn btn-tv" onclick="sendBtn('MENU')">
                                <i class="bi bi-list"></i> Menu
                            </button>
                            <button class="btn btn-tv" onclick="sendBtn('INFO')">
                                <i class="bi bi-info-circle"></i> Info
                            </button>
                            <button class="btn btn-tv" onclick="sendBtn('GUIDE')">
                                <i class="bi bi-grid-3x3"></i> Guia
                            </button>
                        </div>
                        <!-- Color buttons -->
                        <div class="d-flex gap-2 justify-content-center mb-3">
                            <button class="btn" style="background:rgba(220,53,69,0.5);color:#fff;border:1px solid rgba(220,53,69,0.7);min-width:50px" onclick="sendBtn('RED')">‚óè</button>
                            <button class="btn" style="background:rgba(25,135,84,0.5);color:#fff;border:1px solid rgba(25,135,84,0.7);min-width:50px" onclick="sendBtn('GREEN')">‚óè</button>
                            <button class="btn" style="background:rgba(255,193,7,0.5);color:#fff;border:1px solid rgba(255,193,7,0.7);min-width:50px" onclick="sendBtn('YELLOW')">‚óè</button>
                            <button class="btn" style="background:rgba(13,110,253,0.5);color:#fff;border:1px solid rgba(13,110,253,0.7);min-width:50px" onclick="sendBtn('BLUE')">‚óè</button>
                        </div>
                        <!-- Number pad -->
                        <div class="d-flex flex-wrap gap-1 justify-content-center">
                            <button class="btn btn-tv" onclick="sendBtn('NUMBER_1')" style="width:45px">1</button>
                            <button class="btn btn-tv" onclick="sendBtn('NUMBER_2')" style="width:45px">2</button>
                            <button class="btn btn-tv" onclick="sendBtn('NUMBER_3')" style="width:45px">3</button>
                            <button class="btn btn-tv" onclick="sendBtn('NUMBER_4')" style="width:45px">4</button>
                            <button class="btn btn-tv" onclick="sendBtn('NUMBER_5')" style="width:45px">5</button>
                            <button class="btn btn-tv" onclick="sendBtn('NUMBER_6')" style="width:45px">6</button>
                            <button class="btn btn-tv" onclick="sendBtn('NUMBER_7')" style="width:45px">7</button>
                            <button class="btn btn-tv" onclick="sendBtn('NUMBER_8')" style="width:45px">8</button>
                            <button class="btn btn-tv" onclick="sendBtn('NUMBER_9')" style="width:45px">9</button>
                            <button class="btn btn-tv" onclick="sendBtn('LIST')" style="width:45px"><i class="bi bi-list-ol"></i></button>
                            <button class="btn btn-tv" onclick="sendBtn('NUMBER_0')" style="width:45px">0</button>
                            <button class="btn btn-tv" onclick="sendBtn('DASH')" style="width:45px">‚Äî</button>
                        </div>
                    </div>
                </div>

                <!-- Input de Texto -->
                <div class="card mb-3">
                    <div class="card-header"><h5 class="mb-0"><i class="bi bi-keyboard"></i> Teclado</h5></div>
                    <div class="card-body">
                        <div class="input-group mb-2">
                            <input type="text" id="textInput" class="form-control bg-dark text-light border-secondary"
                                   placeholder="Digite o texto..." onkeydown="if(event.key==='Enter')sendText()">
                            <button class="btn btn-tv btn-primary-tv" onclick="sendText()">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-tv" onclick="apiPost('/api/remote', {action:'enter'})">
                                <i class="bi bi-arrow-return-left"></i> Enter
                            </button>
                            <button class="btn btn-sm btn-tv" onclick="apiPost('/api/remote', {action:'delete', count:1})">
                                <i class="bi bi-backspace"></i> Apagar
                            </button>
                            <button class="btn btn-sm btn-tv" onclick="apiPost('/api/remote', {action:'delete', count:10})">
                                <i class="bi bi-trash"></i> Limpar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Cursor / Mouse -->
                <div class="card mb-3">
                    <div class="card-header"><h5 class="mb-0"><i class="bi bi-cursor"></i> Cursor</h5></div>
                    <div class="card-body">
                        <div id="touchpad" style="width:100%;height:150px;background:rgba(0,0,0,0.3);border-radius:8px;border:1px solid rgba(255,255,255,0.1);cursor:crosshair;touch-action:none;display:flex;align-items:center;justify-content:center;">
                            <span class="text-muted">Arraste para mover o cursor</span>
                        </div>
                        <div class="d-flex gap-2 mt-2 justify-content-center">
                            <button class="btn btn-tv btn-primary-tv" onclick="apiPost('/api/remote', {action:'click'})">
                                <i class="bi bi-cursor-fill"></i> Click
                            </button>
                            <button class="btn btn-tv" onclick="apiPost('/api/remote', {action:'scroll', dy:-3})">
                                <i class="bi bi-mouse"></i> Scroll ‚Üë
                            </button>
                            <button class="btn btn-tv" onclick="apiPost('/api/remote', {action:'scroll', dy:3})">
                                <i class="bi bi-mouse"></i> Scroll ‚Üì
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Screenshot -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-camera"></i> Screenshot</h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-tv" onclick="captureScreenshot()" id="btnScreenshot">
                                <i class="bi bi-camera-fill"></i> Capturar
                            </button>
                            <label class="form-check form-switch mb-0 d-flex align-items-center gap-1">
                                <input class="form-check-input" type="checkbox" id="autoScreenshot" onchange="toggleAutoScreenshot()">
                                <span class="small">Auto</span>
                            </label>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <div id="screenshotContainer" style="text-align:center;min-height:80px;display:flex;align-items:center;justify-content:center;">
                            <span class="text-muted small">Clique em Capturar para ver a tela da TV</span>
                        </div>
                    </div>
                </div>

                <!-- Info do App Atual -->
                <div class="card mb-3">
                    <div class="card-header"><h5 class="mb-0"><i class="bi bi-info-circle"></i> Status da TV</h5></div>
                    <div class="card-body">
                        <div id="tvInfo">
                            <p class="text-muted">Conecte para ver informa√ß√µes</p>
                        </div>
                    </div>
                </div>

                <!-- Toast / Notifica√ß√£o -->
                <div class="card mb-3">
                    <div class="card-header"><h5 class="mb-0"><i class="bi bi-chat-dots"></i> Notifica√ß√£o</h5></div>
                    <div class="card-body">
                        <div class="input-group">
                            <input type="text" id="toastMsg" class="form-control bg-dark text-light border-secondary"
                                   placeholder="Mensagem para a TV..." value="Ol√° da Dashboard! üì∫">
                            <button class="btn btn-tv btn-primary-tv" onclick="sendToast()">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                        <small class="text-muted mt-1 d-block">‚ö†Ô∏è Pode n√£o funcionar no webOS 22 (restri√ß√£o de permiss√£o)</small>
                    </div>
                </div>

                <!-- System Info -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-cpu"></i> Sistema</h5>
                        <button class="btn btn-sm btn-tv" onclick="loadSystemInfo()"><i class="bi bi-arrow-clockwise"></i></button>
                    </div>
                    <div class="card-body">
                        <div id="systemInfo">
                            <p class="text-muted">Clique em <i class="bi bi-arrow-clockwise"></i> para carregar</p>
                        </div>
                    </div>
                </div>

                <!-- Log -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-terminal"></i> Log</h5>
                        <button class="btn btn-sm btn-tv" onclick="document.getElementById('logArea').innerHTML=''">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="logArea" class="log-area"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isMuted = false;
        let isConnected = false;
        let currentApp = '';
        let currentChannel = '';
        let currentChannelNumber = '';
        let eventSource = null;

        function log(msg, type = 'info') {
            const area = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString('pt-BR');
            const cls = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            area.innerHTML += `<div class="log-entry ${cls}">[${time}] ${msg}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        // ‚îÄ‚îÄ‚îÄ SSE: Eventos em tempo real ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function connectSSE() {
            if (eventSource) eventSource.close();
            eventSource = new EventSource('/api/events');

            eventSource.addEventListener('init', (e) => {
                const d = JSON.parse(e.data);
                updateConnectionUI(d.connected);
                if (d.volume !== undefined) updateVolume(d.volume, d.muted);
                if (d.foreground_app) updateForeground(d.foreground_app);
                if (d.channel) updateChannel(d.channelNumber, d.channel);
                log('üîå SSE conectado ‚Äî eventos em tempo real', 'success');
            });

            eventSource.addEventListener('volume', (e) => {
                const d = JSON.parse(e.data);
                updateVolume(d.volume, d.muted);
            });

            eventSource.addEventListener('channel', (e) => {
                const d = JSON.parse(e.data);
                updateChannel(d.channelNumber, d.channelName);
            });

            eventSource.addEventListener('foreground', (e) => {
                const d = JSON.parse(e.data);
                updateForeground(d.appId);
            });

            eventSource.addEventListener('power', (e) => {
                const d = JSON.parse(e.data);
                updatePowerState(d.state);
            });

            eventSource.addEventListener('connection', (e) => {
                const d = JSON.parse(e.data);
                updateConnectionUI(d.connected);
                if (d.connected) log('üì∫ TV conectada', 'success');
                else log('üì∫ TV desconectada', 'error');
            });

            eventSource.onerror = () => {
                log('‚ö†Ô∏è SSE desconectado, reconectando...', 'error');
            };
        }

        function updateVolume(vol, muted) {
            document.getElementById('volumeSlider').value = vol;
            document.getElementById('volumeValue').textContent = vol;
            isMuted = muted;
            const muteBtn = document.getElementById('btnMute');
            muteBtn.className = muted ? 'btn btn-tv btn-danger-tv w-100' : 'btn btn-tv w-100';
            muteBtn.innerHTML = muted
                ? '<i class="bi bi-volume-mute-fill"></i> Mudo (ativado)'
                : '<i class="bi bi-volume-mute-fill"></i> Mudo';
            updateTvInfo();
        }

        function updateChannel(number, name) {
            currentChannel = name || '';
            currentChannelNumber = number || '';
            updateTvInfo();
            if (name) log(`üì° Canal: ${number} ‚Äî ${name}`);
        }

        function updateForeground(appId) {
            currentApp = appId || '';
            const np = document.getElementById('nowPlaying');
            const npText = document.getElementById('nowPlayingText');
            if (appId) {
                // Nomes amig√°veis
                const names = {
                    'netflix': 'Netflix', 'youtube.leanback.v4': 'YouTube',
                    'amazon.lovefilm.de': 'Prime Video', 'com.disney.disneyplus-prod': 'Disney+',
                    'spotify-beehive': 'Spotify', 'com.webos.app.livetv': 'TV ao vivo',
                    'com.webos.app.browser': 'Browser', 'com.webos.app.hdmi1': 'HDMI 1',
                    'com.webos.app.hdmi2': 'HDMI 2', 'com.webos.app.hdmi3': 'HDMI 3',
                };
                npText.textContent = names[appId] || appId;
                np.classList.remove('d-none');
            } else {
                np.classList.add('d-none');
            }
            updateTvInfo();
        }

        function updatePowerState(state) {
            if (state === 'Suspend' || state === 'Active Standby') {
                log('‚è∏Ô∏è TV em standby', 'error');
                updateConnectionUI(false);
            } else if (state === 'Active') {
                log('‚ñ∂Ô∏è TV ativa');
            }
        }

        function updateTvInfo() {
            let html = '';
            html += `<div class="mb-1"><i class="bi bi-volume-up"></i> <strong>Volume:</strong> ${document.getElementById('volumeSlider').value} ${isMuted ? '<span class="badge bg-danger">Mudo</span>' : ''}</div>`;
            if (currentApp) html += `<div class="mb-1"><i class="bi bi-app"></i> <strong>App:</strong> <code>${currentApp}</code></div>`;
            if (currentChannel) html += `<div class="mb-1"><i class="bi bi-broadcast"></i> <strong>Canal:</strong> ${currentChannelNumber} ‚Äî ${currentChannel}</div>`;
            html += `<div class="mt-2"><span class="badge ${isConnected ? 'bg-success' : 'bg-secondary'}"><i class="bi bi-activity"></i> Eventos em tempo real</span></div>`;
            document.getElementById('tvInfo').innerHTML = html;
        }

        async function apiPost(url, data) {
            try {
                const resp = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await resp.json();
                if (result.ok) {
                    log(`‚úÖ ${url.split('/').pop()}: ${JSON.stringify(data)}`, 'success');
                } else {
                    log(`‚ùå ${result.message}`, 'error');
                }
                return result;
            } catch (e) {
                log(`‚ùå Erro: ${e.message}`, 'error');
            }
        }

        async function apiGet(url) {
            try {
                const resp = await fetch(url);
                return await resp.json();
            } catch (e) {
                log(`‚ùå GET ${url}: ${e.message}`, 'error');
                return null;
            }
        }

        async function toggleConnection() {
            const btn = document.getElementById('btnConnect');
            if (isConnected) {
                await apiPost('/api/disconnect', {});
                updateConnectionUI(false);
            } else {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Conectando...';
                log('Conectando √† TV... (aceite na tela se for a primeira vez)');
                const result = await apiPost('/api/connect', {});
                btn.disabled = false;
                if (result && result.ok) {
                    updateConnectionUI(true);
                } else {
                    updateConnectionUI(false);
                }
            }
        }

        function updateConnectionUI(connected) {
            isConnected = connected;
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const btn = document.getElementById('btnConnect');
            dot.className = 'status-dot ' + (connected ? 'connected' : 'disconnected');
            text.textContent = connected ? 'Conectado' : 'Desconectado';
            btn.innerHTML = connected
                ? '<i class="bi bi-plug-fill"></i> Desconectar'
                : '<i class="bi bi-plug"></i> Conectar';
            btn.className = connected
                ? 'btn btn-sm btn-tv btn-danger-tv'
                : 'btn btn-sm btn-tv btn-success-tv';
            updateTvInfo();
        }

        async function powerOn() {
            log('Enviando Magic Packet (WOL)...');
            const result = await apiPost('/api/power', {action: 'on'});
            if (result && result.ok) {
                log('Magic Packet enviado! A TV pode levar alguns segundos para ligar.', 'success');
                // Auto-retry connection after 8 seconds
                setTimeout(async () => {
                    log('Tentando conectar √† TV...');
                    const conn = await apiPost('/api/connect', {});
                    if (conn && conn.ok) {
                        updateConnectionUI(true);
                    } else {
                        log('TV ainda n√£o respondeu. Tente conectar manualmente em alguns segundos.', 'error');
                    }
                }, 8000);
            }
        }

        async function toggleMute() {
            isMuted = !isMuted;
            await apiPost('/api/volume', {action: 'mute', mute: isMuted});
        }

        function launchApp(appId) {
            apiPost('/api/apps', {action: 'launch', app_id: appId});
        }

        async function loadApps() {
            log('Carregando lista de apps...');
            const apps = await apiGet('/api/apps');
            if (!apps) return;
            const container = document.getElementById('allApps');
            container.innerHTML = '';
            apps.forEach(app => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-tv app-btn';
                btn.title = app.title;
                btn.textContent = app.title;
                btn.onclick = () => apiPost('/api/apps', {action: 'launch', app_id: app.id});
                container.appendChild(btn);
            });
            log(`${apps.length} apps carregados.`, 'success');
        }

        async function loadInputs() {
            const inputs = await apiGet('/api/inputs');
            if (!inputs) return;
            const container = document.getElementById('inputsList');
            container.innerHTML = '';
            const wrap = document.createElement('div');
            wrap.className = 'd-flex gap-2 flex-wrap';
            inputs.forEach(inp => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-tv' + (inp.connected ? ' btn-success-tv' : '');
                btn.innerHTML = `<i class="bi bi-hdmi-port"></i> ${inp.label}`;
                btn.onclick = () => apiPost('/api/inputs', {input_id: inp.id});
                wrap.appendChild(btn);
            });
            container.appendChild(wrap);
        }

        async function loadChannels() {
            const channels = await apiGet('/api/channels');
            if (!channels) return;
            const select = document.getElementById('channelSelect');
            select.innerHTML = '';
            channels.forEach(ch => {
                const opt = document.createElement('option');
                opt.value = ch.id;
                opt.textContent = `${ch.number} ‚Äî ${ch.name}`;
                select.appendChild(opt);
            });
            document.getElementById('channelList').classList.remove('d-none');
            log(`${channels.length} canais carregados.`, 'success');
        }

        async function sendToast() {
            const msg = document.getElementById('toastMsg').value;
            if (msg) await apiPost('/api/toast', {message: msg});
        }

        async function loadSystemInfo() {
            const data = await apiGet('/api/info');
            if (!data) return;
            const container = document.getElementById('systemInfo');
            let html = '<div class="small">';
            if (data.system) {
                const labels = {modelName:'Modelo', serialNumber:'N¬∫ S√©rie', receiverType:'Receptor'};
                for (const [k, v] of Object.entries(data.system)) {
                    if (k === 'returnValue') continue;
                    const label = labels[k] || k;
                    html += `<div><strong>${label}:</strong> ${JSON.stringify(v)}</div>`;
                }
            }
            if (data.foreground) {
                html += `<div class="mt-2"><strong>App Atual:</strong> ${data.foreground.appId || '?'}</div>`;
            }
            if (data.services) {
                html += `<div class="mt-2"><strong>Servi√ßos:</strong> ${data.services.length} dispon√≠veis</div>`;
                html += `<div class="text-muted" style="font-size:0.7rem">${data.services.join(', ')}</div>`;
            }
            html += '</div>';
            container.innerHTML = html;
            log('Info do sistema carregada.', 'success');
        }

        // Presets
        async function loadPresets() {
            const presets = await apiGet('/api/presets');
            if (!presets) return;
            const container = document.getElementById('presetsList');
            container.innerHTML = '';
            presets.forEach(p => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-tv btn-primary-tv';
                btn.innerHTML = `<i class="bi ${p.icon || 'bi-star'}"></i> ${p.name}`;
                btn.title = p.actions.map(a => {
                    if (a.type === 'app') return `App: ${a.app_id}`;
                    if (a.type === 'volume') return `Vol: ${a.level}`;
                    if (a.type === 'input') return `Input: ${a.input_id}`;
                    if (a.type === 'power') return `Power: ${a.action}`;
                    return JSON.stringify(a);
                }).join(' ‚Üí ');
                btn.onclick = () => executePreset(p.id);

                const wrap = document.createElement('div');
                wrap.className = 'd-flex align-items-center gap-1';
                wrap.appendChild(btn);
                const del = document.createElement('button');
                del.className = 'btn btn-sm btn-tv btn-danger-tv';
                del.innerHTML = '√ó';
                del.style.fontSize = '0.7rem';
                del.style.padding = '2px 6px';
                del.onclick = (e) => { e.stopPropagation(); deletePreset(p.id); };
                wrap.appendChild(del);
                container.appendChild(wrap);
            });
            if (presets.length === 0) container.innerHTML = '<p class="text-muted small">Nenhum favorito. Clique em + para criar.</p>';
        }

        async function executePreset(id) {
            log(`Executando preset "${id}"...`);
            const result = await apiPost('/api/presets', {action: 'execute', id});
            if (result && result.ok) {
                log(`‚úÖ ${result.preset}: ${result.results.join(', ')}`, 'success');
            }
        }

        async function deletePreset(id) {
            if (!confirm(`Remover favorito "${id}"?`)) return;
            await apiPost('/api/presets', {action: 'delete', id});
            loadPresets();
        }

        function showPresetEditor() {
            document.getElementById('presetEditor').classList.remove('d-none');
            document.getElementById('presetId').value = '';
            document.getElementById('presetName').value = '';
        }

        function addPresetAction() {
            const container = document.getElementById('presetActions');
            const html = `<div class="preset-action row g-1 mb-1">
                <div class="col-4">
                    <select class="form-select form-select-sm bg-dark text-light border-secondary preset-action-type" onchange="updateActionFields(this)">
                        <option value="app">App</option>
                        <option value="volume">Volume</option>
                        <option value="input">Input HDMI</option>
                        <option value="power">Power</option>
                    </select>
                </div>
                <div class="col-7 preset-action-value">
                    <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="App ID">
                </div>
                <div class="col-1">
                    <button class="btn btn-sm btn-tv btn-danger-tv" onclick="this.closest('.preset-action').remove()">√ó</button>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        function updateActionFields(sel) {
            const valueDiv = sel.closest('.preset-action').querySelector('.preset-action-value');
            const type = sel.value;
            if (type === 'app') valueDiv.innerHTML = '<input type="text" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="App ID (ex: netflix)">';
            else if (type === 'volume') valueDiv.innerHTML = '<input type="number" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="N√≠vel (0-100)" min="0" max="100">';
            else if (type === 'input') valueDiv.innerHTML = '<select class="form-select form-select-sm bg-dark text-light border-secondary"><option value="HDMI_1">HDMI 1</option><option value="HDMI_2">HDMI 2</option><option value="HDMI_3">HDMI 3</option></select>';
            else if (type === 'power') valueDiv.innerHTML = '<select class="form-select form-select-sm bg-dark text-light border-secondary"><option value="off">Desligar</option><option value="screen_off">Tela Off</option></select>';
        }

        async function savePreset() {
            const id = document.getElementById('presetId').value.trim();
            const name = document.getElementById('presetName').value.trim();
            if (!id || !name) { alert('ID e nome s√£o obrigat√≥rios'); return; }

            const actions = [];
            document.querySelectorAll('.preset-action').forEach(row => {
                const type = row.querySelector('.preset-action-type').value;
                const valEl = row.querySelector('.preset-action-value input, .preset-action-value select');
                if (!valEl) return;
                const val = valEl.value;
                if (type === 'app') actions.push({type: 'app', app_id: val});
                else if (type === 'volume') actions.push({type: 'volume', level: parseInt(val)});
                else if (type === 'input') actions.push({type: 'input', input_id: val});
                else if (type === 'power') actions.push({type: 'power', action: val});
            });

            await apiPost('/api/presets', {action: 'save', preset: {id, name, icon: 'bi-star-fill', actions}});
            document.getElementById('presetEditor').classList.add('d-none');
            loadPresets();
        }

        // Inicializa√ß√£o: SSE + presets
        connectSSE();
        loadPresets();

        // Screenshot
        let autoScreenshotInterval = null;

        async function captureScreenshot() {
            const btn = document.getElementById('btnScreenshot');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            try {
                const resp = await fetch('/api/screenshot?t=' + Date.now());
                if (resp.ok) {
                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    const container = document.getElementById('screenshotContainer');
                    container.innerHTML = `<img src="${url}" style="max-width:100%;border-radius:6px;cursor:pointer" onclick="window.open('${url}','_blank')" title="Clique para abrir em tamanho real">`;
                    log('Screenshot capturado.', 'success');
                } else {
                    const err = await resp.json();
                    log(`‚ùå Screenshot: ${err.message}`, 'error');
                }
            } catch (e) {
                log(`‚ùå Screenshot: ${e.message}`, 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-camera-fill"></i> Capturar';
        }

        function toggleAutoScreenshot() {
            const on = document.getElementById('autoScreenshot').checked;
            if (on) {
                captureScreenshot();
                autoScreenshotInterval = setInterval(captureScreenshot, 3000);
                log('Auto-screenshot ativado (3s).', 'success');
            } else {
                clearInterval(autoScreenshotInterval);
                autoScreenshotInterval = null;
                log('Auto-screenshot desativado.');
            }
        }

        // Remote button helper
        function sendBtn(name) {
            apiPost('/api/remote', {action: 'button', name: name});
        }

        function sendText() {
            const input = document.getElementById('textInput');
            if (input.value) {
                apiPost('/api/remote', {action: 'text', text: input.value});
                input.value = '';
            }
        }

        // Touchpad for cursor control
        (function() {
            const pad = document.getElementById('touchpad');
            let lastX = 0, lastY = 0, active = false;

            function onStart(e) {
                active = true;
                const p = getPos(e);
                lastX = p.x; lastY = p.y;
                e.preventDefault();
            }
            function onMove(e) {
                if (!active) return;
                const p = getPos(e);
                const dx = Math.round((p.x - lastX) * 2);
                const dy = Math.round((p.y - lastY) * 2);
                lastX = p.x; lastY = p.y;
                if (dx !== 0 || dy !== 0) {
                    fetch('/api/remote', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({action: 'move', dx, dy})
                    });
                }
                e.preventDefault();
            }
            function onEnd() { active = false; }
            function getPos(e) {
                if (e.touches) return {x: e.touches[0].clientX, y: e.touches[0].clientY};
                return {x: e.clientX, y: e.clientY};
            }

            pad.addEventListener('mousedown', onStart);
            pad.addEventListener('mousemove', onMove);
            pad.addEventListener('mouseup', onEnd);
            pad.addEventListener('mouseleave', onEnd);
            pad.addEventListener('touchstart', onStart, {passive: false});
            pad.addEventListener('touchmove', onMove, {passive: false});
            pad.addEventListener('touchend', onEnd);
        })();

        // Atalhos de teclado
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            switch(e.key) {
                case 'ArrowUp': apiPost('/api/volume', {action:'up'}); break;
                case 'ArrowDown': apiPost('/api/volume', {action:'down'}); break;
                case 'ArrowRight': apiPost('/api/channels', {action:'up'}); break;
                case 'ArrowLeft': apiPost('/api/channels', {action:'down'}); break;
                case 'm': toggleMute(); break;
                case ' ': e.preventDefault(); apiPost('/api/media', {action:'pause'}); break;
            }
        });
    </script>
</body>
</html>
